<!-- Global Contest Mode Script - Include this in base template when user is in contest -->
<script type="text/javascript">
    (function () {
        'use strict';

        // Contest mode state - available globally
        window.dmojContestMode = window.dmojContestMode || {
            inContest: {{ 'true' if request.user.is_authenticated and request.profile.current_contest and not request.participation.spectate else 'false' }},
            contestKey: {{ request.profile.current_contest.contest.key|escapejs if request.user.is_authenticated and request.profile.current_contest else 'null' }},
            hasExitedContest: false,
            tabSwitchCount: 0,
            initialized: false
        };

        // Only initialize if user is in contest and not already initialized
        if (!window.dmojContestMode.inContest || window.dmojContestMode.initialized) {
            return;
        }

        console.log('Initializing simplified contest mode for contest:', window.dmojContestMode.contestKey);

        // Mark as initialized to prevent multiple initializations
        window.dmojContestMode.initialized = true;

        // Load stored tab switch count
        var storageKey = 'dmoj_tab_switch_count_' + window.dmojContestMode.contestKey;
        var storedCount = localStorage.getItem(storageKey);
        window.dmojContestMode.tabSwitchCount = storedCount ? parseInt(storedCount, 10) : 0;

        console.log('Loaded tab switch count from storage:', window.dmojContestMode.tabSwitchCount);

        // Tab switching detection variables
        var isWindowFocused = !document.hidden;
        var lastBlurTime = 0;
        var switchCooldown = false;

        // Function to update tab switch count display
        function updateTabSwitchDisplay() {
            var counter = document.getElementById('tab-switch-counter');
            if (counter) {
                counter.innerHTML = 
                    '<div>Tab Switches: ' + window.dmojContestMode.tabSwitchCount + '</div>' +
                    '<div style="font-size: 12px; margin-top: 2px;">Monitoring active</div>';
            }
        }

        // Function to create tab switch counter if it doesn't exist
        function createTabSwitchCounter() {
            if (document.getElementById('tab-switch-counter')) {
                return document.getElementById('tab-switch-counter');
            }

            var counter = document.createElement('div');
            counter.id = 'tab-switch-counter';
            counter.style.cssText = 
                'position: fixed; top: 10px; right: 10px; background: rgba(220, 53, 69, 0.9); color: white; ' +
                'padding: 8px 12px; border-radius: 4px; font-family: monospace; font-size: 14px; z-index: 10000; ' +
                'box-shadow: 0 2px 10px rgba(0,0,0,0.3); border: 1px solid #dc3545;';

            // Try to insert in different locations
            var targetParent = document.body || document.documentElement;
            if (targetParent) {
                targetParent.appendChild(counter);
                console.log('Tab switch counter created and added to:', targetParent.tagName);
                return counter;
            }
            
            return null;
        }

        // Function to increment tab switch count
        function incrementTabSwitch(method) {
            if (window.dmojContestMode.hasExitedContest || switchCooldown) {
                console.log('Tab switch ignored - contest exited or cooldown active');
                return;
            }

            // Set cooldown to prevent rapid increments
            switchCooldown = true;
            setTimeout(function() {
                switchCooldown = false;
            }, 1500);

            // Increment count
            window.dmojContestMode.tabSwitchCount++;
            
            // Store in localStorage
            localStorage.setItem(storageKey, window.dmojContestMode.tabSwitchCount.toString());
            
            console.log('TAB SWITCH DETECTED (' + method + ') - Count:', window.dmojContestMode.tabSwitchCount);
            
            // Update display
            updateTabSwitchDisplay();
        }

        // Window blur event (when user switches away)
        window.addEventListener('blur', function() {
            lastBlurTime = Date.now();
            isWindowFocused = false;
            console.log('Window BLUR - user might have switched away');
        });

        // Window focus event (when user comes back)
        window.addEventListener('focus', function() {
            var now = Date.now();
            var blurDuration = lastBlurTime > 0 ? now - lastBlurTime : 0;
            
            console.log('Window FOCUS - blur duration:', blurDuration + 'ms');
            
            // If window was blurred for more than 800ms, count as tab switch
            if (!isWindowFocused && blurDuration > 800) {
                incrementTabSwitch('FOCUS_BLUR');
            }
            
            isWindowFocused = true;
        });

        // Page visibility change (backup detection method)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page became HIDDEN');
                lastBlurTime = Date.now();
                isWindowFocused = false;
            } else {
                console.log('Page became VISIBLE');
                var now = Date.now();
                var hiddenDuration = lastBlurTime > 0 ? now - lastBlurTime : 0;
                
                // If page was hidden for more than 800ms, count as tab switch
                if (!isWindowFocused && hiddenDuration > 800) {
                    incrementTabSwitch('VISIBILITY_CHANGE');
                }
                
                isWindowFocused = true;
            }
        });

        // Initialize the counter display
        function initializeCounter() {
            var counter = createTabSwitchCounter();
            if (counter) {
                updateTabSwitchDisplay();
                console.log('Tab switch counter initialized with count:', window.dmojContestMode.tabSwitchCount);
            } else {
                console.error('Failed to create tab switch counter');
            }
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCounter);
        } else {
            initializeCounter();
        }

        console.log('Tab switching detection initialized with simplified focus/blur and visibility detection');
    }

    // Store tab switch count in localStorage
    function storeTabSwitchCount(count) {
        var storageKey = 'dmoj_tab_switch_count_' + window.dmojContestMode.contestKey;
        localStorage.setItem(storageKey, count.toString());
    }

    function getStoredTabSwitchCount() {
        var storageKey = 'dmoj_tab_switch_count_' + window.dmojContestMode.contestKey;
        var storedCount = localStorage.getItem(storageKey);
        return storedCount ? parseInt(storedCount, 10) : 0;
    }

    function storeLastTotalTabSwitches(count) {
        var storageKey = 'dmoj_last_total_tab_switches_' + window.dmojContestMode.contestKey;
        localStorage.setItem(storageKey, count.toString());
        console.log('Stored last total tab switches:', count);
    }

    function getStoredLastTotalTabSwitches() {
        var storageKey = 'dmoj_last_total_tab_switches_' + window.dmojContestMode.contestKey;
        var storedCount = localStorage.getItem(storageKey);
        return storedCount ? parseInt(storedCount, 10) : 0;
    }

    function clearStoredTabSwitchCount() {
        var storageKey = 'dmoj_tab_switch_count_' + window.dmojContestMode.contestKey;
        console.log('Clearing stored tab switch count for key:', storageKey);

        // Store the current count as the last total before clearing
        if (window.dmojContestMode.tabSwitchCount > 0) {
            window.dmojContestMode.lastTotalTabSwitches = window.dmojContestMode.tabSwitchCount;
            storeLastTotalTabSwitches(window.dmojContestMode.lastTotalTabSwitches);
        }

        localStorage.removeItem(storageKey);
    }

    // Create tab switch counter display
    function createTabSwitchCounter() {
        // Remove any existing counter first
        var existingCounter = document.getElementById('tab-switch-counter');
        if (existingCounter) {
            document.body.removeChild(existingCounter);
        }

        var counter = document.createElement('div');
        counter.id = 'tab-switch-counter';
        counter.style.cssText =
            'position: fixed;' +
            'top: 10px;' +
            'right: 10px;' +
            'background-color: rgba(52, 152, 219, 0.9);' +
            'color: white;' +
            'padding: 10px 15px;' +
            'border-radius: 5px;' +
            'font-family: Arial, sans-serif;' +
            'font-size: 14px;' +
            'font-weight: bold;' +
            'z-index: 10000;' +
            'box-shadow: 0 2px 8px rgba(0,0,0,0.3);' +
            'border: 2px solid #3498db;';

        // Update display with current stored count
        updateTabSwitchDisplay(counter);
        document.body.appendChild(counter);
        console.log('Tab switch counter created and displayed with count:', window.dmojContestMode.tabSwitchCount);
        return counter;
    }

    // Update tab switch counter display
    function updateTabSwitchDisplay(counter) {
        if (!counter) {
            counter = document.getElementById('tab-switch-counter');
        }
        if (counter) {
            counter.innerHTML =
                '<div>{{ _("Tab Switches") }}: ' + window.dmojContestMode.tabSwitchCount + '</div>' +
                '<div style="font-size: 12px; margin-top: 2px;">{{ _("Monitoring active") }}</div>';
        }
    }

    // Global function to get the last total tab switches count
    window.dmojContestMode.getLastTotalTabSwitches = function () {
        return window.dmojContestMode.lastTotalTabSwitches;
    };

    // Global function to get the current tab switches count
    window.dmojContestMode.getCurrentTabSwitches = function () {
        return window.dmojContestMode.tabSwitchCount || 0;
    };



    // Initialize when DOM is ready
    function initialize() {
        console.log('DOM ready, initializing simplified contest mode');

        // Check if user just joined a new contest and clear old data
        var joinFlag = getCookie('dmoj_joining_contest');
        if (joinFlag === 'true') {
            console.log('User is joining a new contest, clearing any previous tab switch count');
            clearStoredTabSwitchCount();
            deleteCookie('dmoj_joining_contest');
        }

        // Load stored tab switch count
        if (window.dmojContestMode.tabSwitchCount === null) {
            window.dmojContestMode.tabSwitchCount = getStoredTabSwitchCount();
            console.log('Loaded stored tab switch count on initialization:', window.dmojContestMode.tabSwitchCount);
        }

        // Load stored last total tab switches count
        window.dmojContestMode.lastTotalTabSwitches = getStoredLastTotalTabSwitches();
        console.log('Loaded last total tab switches:', window.dmojContestMode.lastTotalTabSwitches);

        // Initialize tab switching detection and counter if in a contest
        if (window.dmojContestMode.inContest) {
            console.log('User is in contest, initializing tab switching detection');
            initializeTabSwitching();
        }
    }



    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
    
}) ();
</script>